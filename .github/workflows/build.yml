name: Build Moto Kane (Force Build)
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout Source (Fast)
      run: |
        git clone --depth=1 -b lineage-18.1 https://github.com/LineageOS/android_kernel_motorola_exynos9610.git source

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git bc bison flex libssl-dev build-essential libncurses5-dev libncursesw5-dev zlib1g-dev lib32z1 lib32ncurses5-dev liblz4-tool libtinfo5 gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi

    - name: Download Proton Clang
      run: |
        git clone --depth=1 https://github.com/kdrag0n/proton-clang clang

    - name: Configure & Unlock
      run: |
        cd source
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
        
        # Load Config
        make O=out ARCH=arm64 kane_defconfig

        # --- UNLOCKS ---
        echo "CONFIG_CPU_FREQ_GOV_PERFORMANCE=y" >> out/.config
        echo "CONFIG_CPU_FREQ_GOV_ONDEMAND=y" >> out/.config
        echo "CONFIG_CPU_FREQ_STAT=y" >> out/.config
        
        # Force apply config changes
        make O=out ARCH=arm64 olddefconfig

    - name: Build (The 'No-Error' Method)
      run: |
        cd source
        # Add Clang to path but we will point to system tools for the assembler
        export PATH=$GITHUB_WORKSPACE/clang/bin:$PATH
        
        # FLAGS EXPLANATION:
        # HOSTCFLAGS="-fcommon" -> Fixes yylloc multiple definition
        # KCFLAGS="-Wno-error" -> Tells the compiler NOT to stop on warnings (Fixes cgrp error)
        # LD_LIBRARY_PATH -> Ensures clang finds its own libraries
        
        make O=out \
        ARCH=arm64 \
        CC=clang \
        CLANG_TRIPLE=aarch64-linux-gnu- \
        CROSS_COMPILE=aarch64-linux-gnu- \
        CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
        HOSTCFLAGS="-fcommon" \
        KCFLAGS="-Wno-error -Wno-gnu-variable-sized-type-not-at-end" \
        -j$(nproc --all) \
        Image.gz-dtb

    - name: Upload Kernel
      uses: actions/upload-artifact@v4
      with:
        name: Image.gz-dtb
        path: source/out/arch/arm64/boot/Image.gz-dtb
