name: Build Moto Kane (Final Brute Force)
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout Source (Fast)
      run: |
        git clone --depth=1 -b lineage-18.1 https://github.com/LineageOS/android_kernel_motorola_exynos9610.git source

    - name: Install Dependencies & Clang 11
      run: |
        sudo apt-get update
        # We install clang-11 directly from Ubuntu. It supports the old 'sp' register code.
        sudo apt-get install -y git bc bison flex libssl-dev build-essential libncurses5-dev libncursesw5-dev zlib1g-dev lib32z1 lib32ncurses5-dev liblz4-tool libtinfo5 gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi clang-11 lld-11

    - name: Configure Kernel
      run: |
        cd source
        export ARCH=arm64
        # Load the default config
        make O=out ARCH=arm64 HOSTCFLAGS="-fcommon" kane_defconfig

        # 1. DISABLE LTO & STACK PROTECTOR (The usual suspects for build failure)
        sed -i 's/CONFIG_LTO_CLANG=y/# CONFIG_LTO_CLANG is not set/' out/.config
        sed -i 's/CONFIG_CC_STACKPROTECTOR_STRONG=y/# CONFIG_CC_STACKPROTECTOR_STRONG is not set/' out/.config
        echo "CONFIG_LTO_NONE=y" >> out/.config
        echo "CONFIG_CC_STACKPROTECTOR_NONE=y" >> out/.config

        # 2. UNLOCK EVERYTHING
        echo "CONFIG_CPU_FREQ_GOV_PERFORMANCE=y" >> out/.config
        echo "CONFIG_CPU_FREQ_GOV_ONDEMAND=y" >> out/.config
        echo "CONFIG_CPU_FREQ_STAT=y" >> out/.config
        echo "CONFIG_TCP_CONG_WESTWOOD=y" >> out/.config
        echo "CONFIG_DEFAULT_WESTWOOD=y" >> out/.config
        
        make O=out ARCH=arm64 HOSTCFLAGS="-fcommon" olddefconfig

    - name: Build With System Clang 11
      run: |
        cd source
        # We point everything to the Clang 11 we just installed via apt
        export CC="clang-11"
        export LD="ld.lld-11"
        export AR="llvm-ar-11"
        export NM="llvm-nm-11"
        export OBJCOPY="llvm-objcopy-11"
        export OBJDUMP="llvm-objdump-11"
        export STRIP="llvm-strip-11"

        make O=out \
        ARCH=arm64 \
        CC="$CC" \
        LD="$LD" \
        AR="$AR" \
        NM="$NM" \
        OBJCOPY="$OBJCOPY" \
        OBJDUMP="$OBJDUMP" \
        STRIP="$STRIP" \
        CROSS_COMPILE=aarch64-linux-gnu- \
        CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
        HOSTCFLAGS="-fcommon" \
        KCFLAGS="-Wno-error -Wno-gnu-variable-sized-type-not-at-end -fno-stack-protector" \
        -j$(nproc --all) \
        Image.gz-dtb

    - name: Upload Kernel
      uses: actions/upload-artifact@v4
      with:
        name: Image.gz-dtb
        path: source/out/arch/arm64/boot/Image.gz-dtb
