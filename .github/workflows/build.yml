name: Build Moto One Vision Kernel (Unlocked)
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout Source
      run: |
        git clone https://github.com/MotorolaMobilityLLC/kernel-exynos9610.git source
        cd source
        git checkout RSAS31.Q1-48-36-23

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git bc bison flex libssl-dev build-essential libncurses5-dev libncursesw5-dev zlib1g-dev lib32z1 lib32ncurses5-dev liblz4-tool libtinfo5

    - name: Download Proton Clang
      run: |
        git clone --depth=1 https://github.com/kdrag0n/proton-clang clang

    - name: Configure & Unlock EVERYTHING
      run: |
        cd source
        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=$GITHUB_WORKSPACE/clang/bin/aarch64-linux-gnu-
        export CC=clang
        
        # 1. Load the default config
        if [ -f "arch/arm64/configs/exynos9609-kane_defconfig" ]; then
           make O=out exynos9609-kane_defconfig
        else
           make O=out kane_defconfig
        fi

        # 2. THE UNLOCKER (Modifying the .config file)
        
        # --- CPU GOVERNORS (Enable All) ---
        echo "CONFIG_CPU_FREQ_GOV_PERFORMANCE=y" >> out/.config
        echo "CONFIG_CPU_FREQ_GOV_POWERSAVE=y" >> out/.config
        echo "CONFIG_CPU_FREQ_GOV_USERSPACE=y" >> out/.config
        echo "CONFIG_CPU_FREQ_GOV_ONDEMAND=y" >> out/.config
        echo "CONFIG_CPU_FREQ_GOV_CONSERVATIVE=y" >> out/.config
        
        # --- TCP CONGESTION (Better Ping/WiFi) ---
        # Westwood is legendary for mobile data/wifi stability
        echo "CONFIG_TCP_CONG_WESTWOOD=y" >> out/.config
        echo "CONFIG_DEFAULT_WESTWOOD=y" >> out/.config
        
        # --- I/O SCHEDULERS (Snappier Loading) ---
        # Trying to enable Zen/FIOPS if the code supports it
        echo "CONFIG_IOSCHED_ZEN=y" >> out/.config
        echo "CONFIG_IOSCHED_FIOPS=y" >> out/.config
        
        # --- EXTRAS ---
        # Allow apps to read frequency stats (needed for FDE.AI/Kernel Managers)
        echo "CONFIG_CPU_FREQ_STAT=y" >> out/.config
        
        # Force config to update
        make O=out olddefconfig

    - name: Build Kernel
      run: |
        cd source
        export PATH=$GITHUB_WORKSPACE/clang/bin:$PATH
        make O=out \
        CC=clang \
        CLANG_TRIPLE=aarch64-linux-gnu- \
        CROSS_COMPILE=aarch64-linux-gnu- \
        CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
        -j$(nproc --all) \
        Image.gz-dtb

    - name: Upload Kernel
      uses: actions/upload-artifact@v4
      with:
        name: Image.gz-dtb
        path: source/out/arch/arm64/boot/Image.gz-dtb
