name: Build Moto Kane (The Correct Way)
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout Source (Fast)
      run: |
        git clone --depth=1 -b lineage-18.1 https://github.com/LineageOS/android_kernel_motorola_exynos9610.git source

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git bc bison flex libssl-dev build-essential libncurses5-dev libncursesw5-dev zlib1g-dev lib32z1 lib32ncurses5-dev liblz4-tool libtinfo5

    - name: Download Period-Correct Toolchain (Clang 10)
      run: |
        # This is an older Clang that is compatible with the old kernel source.
        # This will fix the 'register "sp"' and other compilation errors.
        git clone --depth=1 https://github.com/AOSP-Pixel-Experience-Devices/aosp-clang.git clang

    - name: Configure Kernel
      run: |
        cd source
        
        # 1. Load the defconfig
        make O=out ARCH=arm64 HOSTCFLAGS="-fcommon" kane_defconfig

        # 2. Disable unnecessary security/optimizations that cause issues
        sed -i 's/CONFIG_LTO_CLANG=y/# CONFIG_LTO_CLANG is not set/' out/.config
        sed -i 's/CONFIG_CC_STACKPROTECTOR_STRONG=y/# CONFIG_CC_STACKPROTECTOR_STRONG is not set/' out/.config
        echo "CONFIG_LTO_NONE=y" >> out/.config
        echo "CONFIG_CC_STACKPROTECTOR_NONE=y" >> out/.config

        # 3. UNLOCK GOVERNORS
        echo "CONFIG_CPU_FREQ_GOV_PERFORMANCE=y" >> out/.config
        echo "CONFIG_CPU_FREQ_GOV_ONDEMAND=y" >> out/.config
        echo "CONFIG_CPU_FREQ_STAT=y" >> out/.config
        
        # 4. Update the config
        make O=out ARCH=arm64 HOSTCFLAGS="-fcommon" olddefconfig

    - name: Build With Compatible Toolchain
      run: |
        cd source
        export PATH=$GITHUB_WORKSPACE/clang/bin:$PATH
        export CLANG_TRIPLE=aarch64-linux-gnu-
        
        make O=out \
        ARCH=arm64 \
        CC=clang \
        AS=llvm-as \
        LD=ld.lld \
        AR=llvm-ar \
        NM=llvm-nm \
        STRIP=llvm-strip \
        OBJCOPY=llvm-objcopy \
        OBJDUMP=llvm-objdump \
        READELF=llvm-readelf \
        HOSTCFLAGS="-fcommon" \
        -j$(nproc --all) \
        Image.gz-dtb

    - name: Upload Kernel
      uses: actions/upload-artifact@v4
      with:
        name: Image.gz-dtb
        path: source/out/arch/arm64/boot/Image.gz-dtb
